<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DramaThread</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=DotGothic16&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #111118;
  --bg3: #18181f;
  --border: #2a2a35;
  --border2: #333345;
  --text: #f0f0f5;
  --text2: #888899;
  --text3: #555566;
  --neon: #00f5c4;
  --neon2: #7b5cfa;
  --neon3: #fa5c8a;
  --neon4: #f5c842;
  --card: #13131a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Zen Kaku Gothic New', sans-serif;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; min-height: 100vh; }
.page.active { display: block; }

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
.app {
  max-width: 620px;
  margin: 0 auto;
  padding-bottom: 80px;
}

/* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
.topnav {
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(10,10,15,0.85);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.nav-logo {
  font-family: 'DotGothic16', monospace;
  font-size: 20px;
  color: var(--neon);
  letter-spacing: 0.05em;
  text-shadow: 0 0 20px rgba(0,245,196,0.5);
  cursor: pointer;
}
.nav-logo span { color: var(--neon2); }
.nav-right { display: flex; gap: 8px; align-items: center; }
.nav-icon-btn {
  width: 36px; height: 36px;
  border-radius: 50%;
  border: none;
  background: var(--bg3);
  color: var(--text2);
  font-size: 17px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.nav-icon-btn:hover { background: var(--border2); color: var(--text); }

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottomnav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 50;
  background: rgba(10,10,15,0.92);
  backdrop-filter: blur(16px);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 8px 0 16px;
  max-width: 100%;
}
.bnav-btn {
  display: flex; flex-direction: column;
  align-items: center; gap: 3px;
  background: none; border: none;
  color: var(--text3);
  font-size: 22px;
  cursor: pointer;
  transition: color 0.2s;
  padding: 4px 16px;
  font-family: 'Zen Kaku Gothic New', sans-serif;
}
.bnav-btn span { font-size: 10px; letter-spacing: 0.05em; }
.bnav-btn.active { color: var(--neon); }
.bnav-btn:hover { color: var(--text); }

/* ‚îÄ‚îÄ FEED TABS ‚îÄ‚îÄ */
.feed-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  position: sticky;
  top: 52px;
  z-index: 40;
}
.feed-tab {
  flex: 1;
  padding: 14px 0;
  text-align: center;
  font-size: 14px;
  font-weight: 500;
  color: var(--text3);
  background: none;
  border: none;
  cursor: pointer;
  transition: color 0.2s;
  position: relative;
  letter-spacing: 0.03em;
}
.feed-tab.active { color: var(--text); }
.feed-tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px; left: 20%; right: 20%;
  height: 2px;
  background: var(--neon);
  border-radius: 2px;
  box-shadow: 0 0 8px var(--neon);
}

/* ‚îÄ‚îÄ POST COMPOSER (Threads style) ‚îÄ‚îÄ */
.composer {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 12px;
}
.composer-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--neon2), var(--neon3));
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  font-weight: 700;
  flex-shrink: 0;
  position: relative;
}
.composer-avatar::after {
  content: '';
  position: absolute;
  bottom: -22px; left: 50%;
  transform: translateX(-50%);
  width: 2px; height: 18px;
  background: var(--border2);
}
.composer-right { flex: 1; }
.composer-name {
  font-size: 14px; font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
}
.composer-inputs { display: flex; flex-direction: column; gap: 8px; }
.c-input {
  background: none;
  border: none;
  outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 15px;
  color: var(--text);
  width: 100%;
  resize: none;
}
.c-input::placeholder { color: var(--text3); }
.c-drama-input {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 13px;
  color: var(--text2);
  width: 100%;
  outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  transition: border-color 0.2s;
}
.c-drama-input:focus { border-color: var(--neon); color: var(--text); }
.c-drama-input::placeholder { color: var(--text3); }

/* STAR ROW */
.c-stars { display: flex; gap: 4px; align-items: center; }
.c-star {
  background: none; border: none;
  font-size: 20px; cursor: pointer;
  color: var(--border2);
  transition: color 0.1s, transform 0.1s;
  padding: 0;
}
.c-star.on { color: var(--neon4); }
.c-star:hover { transform: scale(1.2); }

/* SPOILER CHIP */
.c-spoiler-chip {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  user-select: none;
  transition: all 0.2s;
}
.c-spoiler-chip.on {
  border-color: var(--neon3);
  color: var(--neon3);
  background: rgba(250,92,138,0.08);
}
.c-spoiler-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--border2);
  transition: background 0.2s;
}
.c-spoiler-chip.on .c-spoiler-dot { background: var(--neon3); box-shadow: 0 0 6px var(--neon3); }

.composer-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.c-tools { display: flex; gap: 8px; align-items: center; }
.c-tool-btn {
  background: none; border: none;
  color: var(--text3); font-size: 18px;
  cursor: pointer; padding: 4px;
  transition: color 0.2s;
}
.c-tool-btn:hover { color: var(--neon); }
.c-chars { font-size: 12px; color: var(--text3); }

.post-btn {
  background: var(--text);
  color: var(--bg);
  border: none;
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  transition: all 0.2s;
  letter-spacing: 0.03em;
}
.post-btn:hover {
  background: var(--neon);
  box-shadow: 0 0 16px rgba(0,245,196,0.4);
}
.post-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* ‚îÄ‚îÄ EPISODE DROPDOWN ‚îÄ‚îÄ */
.ep-field-wrap {
  position: relative;
}
.ep-dropdown-btn {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 10px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 13px;
  color: var(--text2);
  transition: border-color 0.2s;
  user-select: none;
}
.ep-dropdown-btn:hover { border-color: var(--neon2); }
.ep-dropdown-btn.open { border-color: var(--neon2); border-radius: 8px 8px 0 0; border-bottom-color: transparent; }
.ep-dropdown-btn .ep-selected-val { color: var(--neon2); font-weight: 700; }
.ep-dropdown-btn .ep-selected-val.default { color: var(--text3); font-weight: 400; }
.ep-dropdown-arrow {
  font-size: 11px;
  color: var(--text3);
  transition: transform 0.2s;
}
.ep-dropdown-btn.open .ep-dropdown-arrow { transform: rotate(180deg); }

.ep-dropdown-menu {
  display: none;
  position: absolute;
  top: 100%; left: 0; right: 0;
  background: var(--bg3);
  border: 1px solid var(--neon2);
  border-top: none;
  border-radius: 0 0 8px 8px;
  z-index: 30;
  max-height: 220px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
  animation: fadeIn 0.15s ease;
}
.ep-dropdown-menu.open { display: block; }
.ep-dropdown-item {
  padding: 10px 14px;
  font-size: 13px;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  color: var(--text2);
  cursor: pointer;
  transition: background 0.1s, color 0.1s;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.ep-dropdown-item:last-child { border-bottom: none; }
.ep-dropdown-item:hover { background: rgba(123,92,250,0.08); color: var(--text); }
.ep-dropdown-item.selected {
  color: var(--neon2);
  font-weight: 700;
  background: rgba(123,92,250,0.1);
}
.ep-dropdown-item.selected::after { content: '‚úì'; font-size: 12px; }
.ep-dropdown-item.all.selected { color: var(--neon); background: rgba(0,245,196,0.07); }
.ep-dropdown-divider {
  padding: 6px 14px 4px;
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
}

/* EPISODE BADGE on posts */
.ep-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(123,92,250,0.12);
  border: 1px solid rgba(123,92,250,0.3);
  color: var(--neon2);
  font-size: 11px; font-weight: 700;
  padding: 2px 9px; border-radius: 20px;
  margin-bottom: 5px;
  letter-spacing: 0.03em;
}
.ep-badge.all {
  background: rgba(0,245,196,0.08);
  border-color: rgba(0,245,196,0.25);
  color: var(--neon);
}

/* DRAMA PAGE EPISODE FILTER */
.ep-filter-bar {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: none;
}
.ep-filter-bar::-webkit-scrollbar { display: none; }
.ep-filter-inner { display: inline-flex; gap: 6px; }
.ep-filter-chip {
  background: var(--bg3);
  border: 1px solid var(--border2);
  color: var(--text2);
  font-size: 12px;
  padding: 5px 14px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  flex-shrink: 0;
}
.ep-filter-chip:hover { border-color: var(--neon2); color: var(--neon2); }
.ep-filter-chip.active {
  background: rgba(123,92,250,0.15);
  border-color: var(--neon2);
  color: var(--neon2);
  font-weight: 700;
}
.ep-filter-chip.all.active {
  background: rgba(0,245,196,0.12);
  border-color: var(--neon);
  color: var(--neon);
}

/* MOD WARNING */
.mod-warn {
  background: rgba(250,92,138,0.1);
  border: 1px solid rgba(250,92,138,0.3);
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 12px;
  color: var(--neon3);
  margin-top: 8px;
  display: none;
}
.mod-warn.show { display: block; }

/* ‚îÄ‚îÄ POST CARD (Threads style) ‚îÄ‚îÄ */
.post-card {
  padding: 16px 16px 0;
  border-bottom: 1px solid var(--border);
  animation: fadeIn 0.3s ease;
  transition: background 0.15s;
}
.post-card:hover { background: rgba(255,255,255,0.01); }
.post-card.frozen { opacity: 0.5; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.post-inner { display: flex; gap: 12px; }
.post-avatar-col { display: flex; flex-direction: column; align-items: center; gap: 0; }
.p-avatar {
  width: 40px; height: 40px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700; flex-shrink: 0;
  position: relative;
}
.p-avatar.has-replies::after {
  content: '';
  position: absolute;
  bottom: -100%; left: 50%; transform: translateX(-50%);
  width: 2px; height: 100%;
  background: var(--border2);
}
.thread-line {
  flex: 1; width: 2px;
  background: var(--border2);
  margin: 4px 0 0;
  min-height: 16px;
}
.post-body-col { flex: 1; min-width: 0; }
.post-head {
  display: flex; align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.p-username { font-size: 14px; font-weight: 700; }
.p-time { font-size: 12px; color: var(--text3); }
.p-drama-tag {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 13px; color: var(--neon);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}
.p-drama-tag:hover {
  text-shadow: 0 0 10px var(--neon);
}
.p-drama-tag .arrow { font-size: 11px; opacity: 0.6; }
.p-stars { display: flex; gap: 2px; margin-bottom: 6px; }
.p-star { font-size: 13px; color: var(--border2); }
.p-star.on { color: var(--neon4); }
.spoiler-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(250,92,138,0.12);
  border: 1px solid rgba(250,92,138,0.3);
  color: var(--neon3);
  font-size: 11px;
  padding: 2px 8px; border-radius: 20px;
  margin-bottom: 6px;
}
.p-text {
  font-size: 15px; line-height: 1.65;
  color: rgba(240,240,245,0.9);
  margin-bottom: 10px;
  word-break: break-word;
}
.spoiler-blur {
  filter: blur(6px);
  user-select: none;
  cursor: pointer;
  transition: filter 0.3s;
  border-radius: 4px;
}
.spoiler-blur.revealed { filter: none; }
.frozen-tag {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(123,92,250,0.12);
  border: 1px solid rgba(123,92,250,0.3);
  color: var(--neon2);
  font-size: 11px;
  padding: 2px 8px; border-radius: 20px;
  margin-bottom: 6px;
}
.post-actions {
  display: flex; gap: 0;
  margin: 2px -8px 0;
  padding-bottom: 4px;
}
.p-action {
  display: flex; align-items: center; gap: 5px;
  background: none; border: none;
  color: var(--text3);
  font-size: 13px;
  cursor: pointer;
  padding: 8px 8px;
  border-radius: 8px;
  transition: all 0.15s;
  font-family: 'Zen Kaku Gothic New', sans-serif;
}
.p-action:hover { color: var(--text); background: var(--bg3); }
.p-action.liked { color: var(--neon3); }
.p-action .icon { font-size: 17px; }
.p-action.liked .icon { animation: heartPop 0.25s ease; }
@keyframes heartPop {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}

/* ‚îÄ‚îÄ DRAMA DETAIL PAGE ‚îÄ‚îÄ */
.drama-page-topnav {
  position: sticky; top: 0; z-index: 50;
  background: rgba(10,10,15,0.9);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  height: 52px;
  display: flex; align-items: center; gap: 14px;
}
.back-btn {
  background: none; border: none;
  color: var(--text); font-size: 22px;
  cursor: pointer; padding: 4px;
  transition: color 0.2s;
  display: flex; align-items: center;
}
.back-btn:hover { color: var(--neon); }
.drama-page-title { font-size: 16px; font-weight: 700; }

.drama-hero {
  padding: 24px 16px 20px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.drama-hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 30% 50%, rgba(0,245,196,0.05), transparent 60%),
              radial-gradient(ellipse at 80% 20%, rgba(123,92,250,0.07), transparent 60%);
  pointer-events: none;
}
.drama-title-row {
  display: flex; align-items: flex-start; gap: 16px;
  margin-bottom: 16px;
}
.drama-thumb {
  width: 72px; height: 96px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--bg3), var(--border2));
  display: flex; align-items: center; justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
  border: 1px solid var(--border2);
}
.drama-info { flex: 1; }
.drama-main-title {
  font-size: 20px; font-weight: 900;
  margin-bottom: 4px;
  line-height: 1.3;
}
.drama-genre-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.genre-chip {
  background: var(--bg3);
  border: 1px solid var(--border2);
  color: var(--text2);
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
}
.drama-rating-big {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 16px;
}
.rating-num {
  font-family: 'DotGothic16', monospace;
  font-size: 42px;
  color: var(--neon4);
  line-height: 1;
  text-shadow: 0 0 20px rgba(245,200,66,0.4);
}
.rating-right { }
.rating-stars-big { display: flex; gap: 3px; margin-bottom: 2px; }
.r-star { font-size: 18px; color: var(--border2); }
.r-star.on { color: var(--neon4); }
.rating-count { font-size: 12px; color: var(--text3); }

/* INFO CARDS */
.drama-info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}
.info-card {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 12px 14px;
}
.info-card-label {
  font-size: 11px; color: var(--text3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.info-card-val {
  font-size: 14px; font-weight: 700;
  color: var(--text);
}
.info-card-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* STREAMING BADGES */
.streaming-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.stream-badge {
  display: flex; align-items: center; gap: 6px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.stream-badge:hover {
  border-color: var(--neon);
  color: var(--neon);
  background: rgba(0,245,196,0.05);
}
.stream-icon { font-size: 18px; }

/* DRAMA PAGE TABS */
.drama-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 52px; z-index: 40;
  background: var(--bg);
}
.drama-tab {
  flex: 1;
  padding: 13px 0;
  text-align: center;
  font-size: 13px; font-weight: 500;
  color: var(--text3);
  background: none; border: none;
  cursor: pointer;
  transition: color 0.2s;
  position: relative;
  letter-spacing: 0.03em;
}
.drama-tab.active { color: var(--text); }
.drama-tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px; left: 20%; right: 20%;
  height: 2px;
  background: var(--neon2);
  border-radius: 2px;
  box-shadow: 0 0 8px var(--neon2);
}

/* STAT BAR */
.stat-bar-wrap { padding: 16px; border-bottom: 1px solid var(--border); }
.stat-bar-row {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 6px;
}
.stat-bar-label { font-size: 12px; color: var(--text3); width: 12px; }
.stat-bar-track {
  flex: 1; height: 4px;
  background: var(--border2); border-radius: 2px;
  overflow: hidden;
}
.stat-bar-fill {
  height: 100%; border-radius: 2px;
  background: linear-gradient(90deg, var(--neon2), var(--neon));
  transition: width 0.6s ease;
}
.stat-bar-cnt { font-size: 12px; color: var(--text2); width: 28px; text-align: right; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 88px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--bg3);
  border: 1px solid var(--border2);
  color: var(--text);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 13px;
  z-index: 200;
  opacity: 0;
  transition: all 0.3s;
  white-space: nowrap;
  pointer-events: none;
}
.toast.show {
  opacity: 1; transform: translateX(-50%) translateY(0);
}
.toast.neon { border-color: var(--neon); color: var(--neon); }
.toast.warn { border-color: var(--neon3); color: var(--neon3); }

/* ‚îÄ‚îÄ REPORT SHEET ‚îÄ‚îÄ */
.sheet-backdrop {
  position: fixed; inset: 0; z-index: 100;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.sheet-backdrop.open { display: flex; }
.sheet {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: 16px 16px 0 0;
  padding: 20px 0 40px;
  width: 100%; max-width: 620px;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.sheet-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 0 auto 16px;
}
.sheet-title {
  font-size: 15px; font-weight: 700;
  text-align: center;
  margin-bottom: 16px;
  padding: 0 16px;
}
.sheet-option {
  display: flex; align-items: center; gap: 14px;
  width: 100%; padding: 14px 20px;
  background: none; border: none;
  color: var(--text); font-size: 15px;
  cursor: pointer;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  transition: background 0.15s;
  text-align: left;
}
.sheet-option:hover { background: var(--bg2); }
.sheet-option.danger { color: var(--neon3); }
.sheet-icon { font-size: 20px; }

/* ‚îÄ‚îÄ SEARCH PAGE ‚îÄ‚îÄ */
.search-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 52px; z-index: 40;
  background: var(--bg);
}
.search-input-wrap {
  display: flex; align-items: center; gap: 10px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 10px 16px;
  transition: border-color 0.2s;
}
.search-input-wrap:focus-within { border-color: var(--neon2); }
.search-icon { font-size: 16px; color: var(--text3); }
.s-input {
  background: none; border: none; outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 15px; color: var(--text); flex: 1;
}
.s-input::placeholder { color: var(--text3); }
.trending-section { padding: 16px; }
.trending-label {
  font-size: 12px; color: var(--text3);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 12px;
}
.trending-drama-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: opacity 0.2s;
}
.trending-drama-item:hover { opacity: 0.7; }
.td-rank {
  font-family: 'DotGothic16', monospace;
  font-size: 18px; font-weight: 700;
  width: 28px;
  color: var(--text3);
}
.td-rank.top { color: var(--neon); text-shadow: 0 0 8px var(--neon); }
.td-info { flex: 1; }
.td-name { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.td-meta { font-size: 12px; color: var(--text3); }
.td-count {
  font-size: 13px; color: var(--text2);
  background: var(--bg3);
  padding: 4px 10px; border-radius: 20px;
}

/* ‚îÄ‚îÄ REPLY AREA ‚îÄ‚îÄ */
.reply-area {
  display: none;
  padding: 0 16px 0 68px;
  border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.015);
  animation: fadeIn 0.2s ease;
}
.reply-area.open { display: block; }

.reply-composer {
  display: flex;
  gap: 10px;
  padding: 12px 0 4px;
}
.reply-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--neon2), var(--neon3));
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700;
  flex-shrink: 0;
}
.reply-input-wrap { flex: 1; }
.reply-name-input {
  background: none; border: none; outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 12px; color: var(--text3);
  width: 100%; margin-bottom: 4px;
}
.reply-name-input::placeholder { color: var(--text3); }
.reply-text-input {
  background: none; border: none; outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 14px; color: var(--text);
  width: 100%; resize: none;
  min-height: 36px;
}
.reply-text-input::placeholder { color: var(--text3); }
.reply-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0 12px;
}
.reply-mod-warn {
  font-size: 12px; color: var(--neon3);
  display: none;
}
.reply-mod-warn.show { display: block; }
.reply-submit-btn {
  background: var(--text); color: var(--bg);
  border: none; padding: 6px 16px;
  border-radius: 20px; font-size: 13px; font-weight: 700;
  cursor: pointer; font-family: 'Zen Kaku Gothic New', sans-serif;
  transition: all 0.2s;
}
.reply-submit-btn:hover { background: var(--neon); box-shadow: 0 0 12px rgba(0,245,196,0.4); }

/* REPLIES LIST */
.replies-list { }
.reply-item {
  display: flex; gap: 10px;
  padding: 10px 0;
  border-top: 1px solid var(--border);
  animation: fadeIn 0.25s ease;
  position: relative;
}
.reply-item::before {
  content: '';
  position: absolute;
  left: -52px; top: 0; bottom: 50%;
  width: 2px;
  background: var(--border2);
  display: none;
}
.r-avatar {
  width: 28px; height: 28px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700;
  flex-shrink: 0;
}
.r-body { flex: 1; min-width: 0; }
.r-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; }
.r-name { font-size: 13px; font-weight: 700; }
.r-time { font-size: 11px; color: var(--text3); }
.r-text { font-size: 14px; line-height: 1.6; color: rgba(240,240,245,0.85); word-break: break-word; }
.r-actions { display: flex; gap: 0; margin-top: 4px; margin-left: -6px; }
.r-action {
  background: none; border: none;
  color: var(--text3); font-size: 12px;
  cursor: pointer; padding: 4px 6px;
  border-radius: 6px;
  transition: all 0.15s;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  display: flex; align-items: center; gap: 3px;
}
.r-action:hover { color: var(--text); background: var(--bg3); }
.r-action.liked { color: var(--neon3); }

/* SHOW REPLIES TOGGLE */
.show-replies-btn {
  background: none; border: none;
  color: var(--neon2); font-size: 13px;
  cursor: pointer; padding: 10px 0 12px;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  display: flex; align-items: center; gap: 5px;
  transition: color 0.2s;
}
.show-replies-btn:hover { color: var(--neon); }

/* ‚îÄ‚îÄ REPLY MODAL (full sheet) ‚îÄ‚îÄ */
.reply-modal-backdrop {
  position: fixed; inset: 0; z-index: 150;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.reply-modal-backdrop.open { display: flex; }
.reply-modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: 20px 20px 0 0;
  width: 100%; max-width: 620px;
  max-height: 85vh;
  display: flex; flex-direction: column;
  animation: slideUp 0.3s ease;
}
.reply-modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.reply-modal-title { font-size: 15px; font-weight: 700; }
.reply-modal-close {
  background: var(--bg3); border: none;
  color: var(--text2); font-size: 16px;
  width: 32px; height: 32px;
  border-radius: 50%; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.reply-modal-close:hover { background: var(--border2); color: var(--text); }
.reply-modal-scroll { overflow-y: auto; flex: 1; }

/* original post preview in modal */
.reply-modal-orig {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  opacity: 0.75;
}
.reply-modal-orig .p-username { font-size: 13px; }
.reply-modal-orig .p-text { font-size: 13px; color: var(--text2); margin-bottom: 0; }

/* reply input in modal */
.reply-modal-input-area {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; gap: 12px;
}
.reply-modal-input-right { flex: 1; }
.reply-modal-name {
  font-size: 12px; color: var(--neon2); margin-bottom: 2px;
  background: none; border: none; outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif; width: 100%;
}
.reply-modal-name::placeholder { color: var(--text3); }
.reply-modal-textarea {
  background: none; border: none; outline: none;
  font-family: 'Zen Kaku Gothic New', sans-serif;
  font-size: 15px; color: var(--text);
  width: 100%; resize: none; min-height: 72px;
}
.reply-modal-textarea::placeholder { color: var(--text3); }
.reply-modal-footer {
  padding: 12px 20px;
  display: flex; justify-content: space-between; align-items: center;
  flex-shrink: 0;
  border-top: 1px solid var(--border);
}
.reply-modal-warn { font-size: 12px; color: var(--neon3); }
.reply-modal-submit {
  background: var(--text); color: var(--bg);
  border: none; padding: 8px 22px;
  border-radius: 20px; font-size: 14px; font-weight: 700;
  cursor: pointer; font-family: 'Zen Kaku Gothic New', sans-serif;
  transition: all 0.2s;
}
.reply-modal-submit:hover { background: var(--neon); box-shadow: 0 0 14px rgba(0,245,196,0.4); }

/* replies in modal */
.modal-replies-list { padding: 0 20px 20px; }
.modal-reply-item {
  display: flex; gap: 10px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  animation: fadeIn 0.2s ease;
}
.modal-reply-item:last-child { border-bottom: none; }

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê FEED PAGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-feed">
  <div class="app">
    <div class="topnav">
      <div class="nav-logo" onclick="goHome()">Drama<span>Thread</span></div>
      <div class="nav-right">
        <button class="nav-icon-btn" title="ÈÄöÁü•">üîî</button>
        <button class="nav-icon-btn" title="DM">‚úâÔ∏è</button>
      </div>
    </div>

    <div class="feed-tabs">
      <button class="feed-tab active" onclick="setFeedTab('all', this)">„Åô„Åπ„Å¶</button>
      <button class="feed-tab" onclick="setFeedTab('nospoiler', this)">„Éç„Çø„Éê„É¨„Å™„Åó</button>
      <button class="feed-tab" onclick="setFeedTab('spoiler', this)">„Éç„Çø„Éê„É¨„ÅÇ„Çä</button>
    </div>

    <!-- COMPOSER -->
    <div class="composer">
      <div>
        <div class="composer-avatar">„ÅÇ</div>
      </div>
      <div class="composer-right">
        <div class="composer-name">„ÅÇ„Å™„Åü</div>
        <div class="composer-inputs">
          <input class="c-drama-input" id="c-drama" placeholder="üì∫ „Éâ„É©„Éû„Çø„Ç§„Éà„É´" autocomplete="off" />
          <!-- Ë©±Êï∞„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
          <div class="ep-field-wrap" id="ep-field-wrap">
            <div class="ep-dropdown-btn" id="ep-dropdown-btn" onclick="toggleEpDropdown()">
              <span id="ep-selected-val" class="ep-selected-val default">üé¨ Ë©±Êï∞„ÇíÈÅ∏„Å∂</span>
              <span class="ep-dropdown-arrow">‚ñº</span>
            </div>
            <div class="ep-dropdown-menu" id="ep-dropdown-menu">
              <div class="ep-dropdown-item all selected" onclick="selectEpisode('ÂÖ®‰Ωì', this)">üì∫ ÂÖ®‰ΩìÔºà„Ç∑„É™„Éº„Ç∫ÂÖ®‰Ωì„ÅÆÊÑüÊÉ≥Ôºâ</div>
              <div class="ep-dropdown-divider">ÂêÑË©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('1Ë©±', this)">1Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('2Ë©±', this)">2Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('3Ë©±', this)">3Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('4Ë©±', this)">4Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('5Ë©±', this)">5Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('6Ë©±', this)">6Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('7Ë©±', this)">7Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('8Ë©±', this)">8Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('9Ë©±', this)">9Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('10Ë©±', this)">10Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('11Ë©±', this)">11Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('12Ë©±', this)">12Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('13Ë©±', this)">13Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('14Ë©±', this)">14Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('15Ë©±', this)">15Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('16Ë©±', this)">16Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('17Ë©±', this)">17Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('18Ë©±', this)">18Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('19Ë©±', this)">19Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('20Ë©±', this)">20Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('21Ë©±', this)">21Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('22Ë©±', this)">22Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('23Ë©±', this)">23Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('24Ë©±', this)">24Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('25Ë©±', this)">25Ë©±</div>
              <div class="ep-dropdown-item" onclick="selectEpisode('ÊúÄÁµÇË©±', this)">üèÅ ÊúÄÁµÇË©±</div>
            </div>
          </div>
          <input class="c-drama-input" id="c-user" placeholder="üë§ „Éã„ÉÉ„ÇØ„Éç„Éº„É†" />
          <textarea class="c-input" id="c-body" rows="2" placeholder="ÊÑüÊÉ≥„Çí„Ç∑„Çß„Ç¢„Åó„Çà„ÅÜ‚Ä¶" oninput="onBodyInput()"></textarea>
          <div class="mod-warn" id="mod-warn">‚ö†Ô∏è <span id="mod-msg"></span></div>
        </div>
        <div class="composer-footer">
          <div class="c-tools">
            <div class="c-stars" id="c-stars">
              <button class="c-star" data-v="1">‚òÖ</button>
              <button class="c-star" data-v="2">‚òÖ</button>
              <button class="c-star" data-v="3">‚òÖ</button>
              <button class="c-star" data-v="4">‚òÖ</button>
              <button class="c-star" data-v="5">‚òÖ</button>
            </div>
            <div class="c-spoiler-chip" id="c-spoiler" onclick="toggleSpoiler()">
              <div class="c-spoiler-dot"></div>
              „Éç„Çø„Éê„É¨
            </div>
          </div>
          <button class="post-btn" id="post-btn" onclick="submitPost()">ÊäïÁ®ø</button>
        </div>
      </div>
    </div>

    <!-- FEED -->
    <div id="feed"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê DRAMA DETAIL PAGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-drama">
  <div class="app">
    <div class="drama-page-topnav">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="drama-page-title" id="drama-page-title">„Éâ„É©„ÉûË©≥Á¥∞</div>
    </div>

    <div id="drama-detail-content"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SEARCH PAGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-search">
  <div class="app">
    <div class="topnav">
      <div class="nav-logo" onclick="goHome()">Drama<span>Thread</span></div>
    </div>
    <div class="search-header">
      <div class="search-input-wrap">
        <span class="search-icon">üîç</span>
        <input class="s-input" placeholder="„Éâ„É©„Éû„ÇíÊ§úÁ¥¢‚Ä¶" oninput="onSearch(this.value)" id="search-inp">
      </div>
    </div>
    <div id="search-results"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottomnav">
  <button class="bnav-btn active" id="bnav-home" onclick="switchPage('feed')">
    <span>üè†</span><span>„Éõ„Éº„É†</span>
  </button>
  <button class="bnav-btn" id="bnav-search" onclick="switchPage('search')">
    <span>üîç</span><span>Ê§úÁ¥¢</span>
  </button>
  <button class="bnav-btn" id="bnav-notif">
    <span>üîî</span><span>ÈÄöÁü•</span>
  </button>
  <button class="bnav-btn" id="bnav-profile" onclick="switchPage('profile')">
    <span>üë§</span><span>„Éó„É≠„Éï„Ç£„Éº„É´</span>
  </button>
</div>

<!-- REPLY MODAL -->
<div class="reply-modal-backdrop" id="reply-modal-backdrop" onclick="closeReplyModal()">
  <div class="reply-modal" onclick="event.stopPropagation()">
    <div class="reply-modal-header">
      <div class="reply-modal-title">Ëøî‰ø°„Åô„Çã</div>
      <button class="reply-modal-close" onclick="closeReplyModal()">‚úï</button>
    </div>
    <div class="reply-modal-scroll">
      <!-- original post preview -->
      <div class="reply-modal-orig" id="reply-modal-orig"></div>
      <!-- reply input -->
      <div class="reply-modal-input-area">
        <div class="reply-avatar" style="width:36px;height:36px;font-size:14px">„ÅÇ</div>
        <div class="reply-modal-input-right">
          <input class="reply-modal-name" id="reply-modal-name" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" />
          <textarea class="reply-modal-textarea" id="reply-modal-text" placeholder="Ëøî‰ø°„ÇíÊõ∏„Åè‚Ä¶" oninput="onReplyInput()"></textarea>
        </div>
      </div>
      <!-- existing replies -->
      <div class="modal-replies-list" id="modal-replies-list"></div>
    </div>
    <div class="reply-modal-footer">
      <span class="reply-modal-warn" id="reply-modal-warn"></span>
      <button class="reply-modal-submit" onclick="submitReply()">Ëøî‰ø°</button>
    </div>
  </div>
</div>


<div class="sheet-backdrop" id="sheet-backdrop" onclick="closeSheet()">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheet-handle"></div>
    <div class="sheet-title">„Åì„ÅÆÊäïÁ®ø„Å´„Å§„ÅÑ„Å¶</div>
    <button class="sheet-option danger" onclick="confirmReport()"><span class="sheet-icon">üö©</span>ÈÄöÂ†±„Åô„Çã</button>
    <button class="sheet-option" onclick="closeSheet()"><span class="sheet-icon">‚úï</span>„Ç≠„É£„É≥„Çª„É´</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>


<!-- ‚ïê‚ïê‚ïê‚ïê AUTH MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="auth-modal" onclick="closeAuthModal()">
  <div class="auth-modal" onclick="event.stopPropagation()">
    <div class="auth-modal-header">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">„É≠„Ç∞„Ç§„É≥</button>
        <button class="auth-tab" id="tab-signup" onclick="switchAuthTab('signup')">Êñ∞Ë¶èÁôªÈå≤</button>
      </div>
      <button class="auth-close" onclick="closeAuthModal()">‚úï</button>
    </div>
    <div class="auth-modal-body">
      <div id="auth-login-form">
        <div class="auth-field"><label class="auth-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label><input class="auth-input" id="login-email" type="email" placeholder="mail@example.com" /></div>
        <div class="auth-field"><label class="auth-label">„Éë„Çπ„ÉØ„Éº„Éâ</label><input class="auth-input" id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <div class="auth-error" id="login-error"></div>
        <button class="auth-submit-btn" onclick="doLogin()">„É≠„Ç∞„Ç§„É≥</button>
        <div class="auth-divider"><span>„Åæ„Åü„ÅØ</span></div>
        <button class="auth-guest-btn" onclick="closeAuthModal()">„Ç≤„Çπ„Éà„Å®„Åó„Å¶Á∂ö„Åë„Çã</button>
      </div>
      <div id="auth-signup-form" style="display:none">
        <div class="auth-field"><label class="auth-label">„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label><input class="auth-input" id="signup-name" type="text" placeholder="‰æãÔºö„Éâ„É©„ÉûÂ•Ω„ÅçËä±Â≠ê" /></div>
        <div class="auth-field"><label class="auth-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label><input class="auth-input" id="signup-email" type="email" placeholder="mail@example.com" /></div>
        <div class="auth-field"><label class="auth-label">„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ</label><input class="auth-input" id="signup-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
        <div class="auth-error" id="signup-error"></div>
        <button class="auth-submit-btn" onclick="doSignup()">ÁôªÈå≤„Åô„Çã</button>
        <div class="auth-divider"><span>„Åæ„Åü„ÅØ</span></div>
        <button class="auth-guest-btn" onclick="closeAuthModal()">„Ç≤„Çπ„Éà„Å®„Åó„Å¶Á∂ö„Åë„Çã</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê PROFILE PAGE ‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-profile">
  <div class="app">
    <div class="topnav">
      <div class="nav-logo" onclick="goHome()">Drama<span>Thread</span></div>
      <div class="nav-right" id="profile-page-nav-right"></div>
    </div>
    <div id="profile-content"></div>
  </div>
</div>

<style>
.modal-backdrop { position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:20px; }
.modal-backdrop.open { display:flex; }
.auth-modal { background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:400px;animation:fadeIn 0.25s ease;overflow:hidden; }
.auth-modal-header { display:flex;align-items:center;justify-content:space-between;padding:16px 20px 0; }
.auth-tabs { display:flex; }
.auth-tab { padding:10px 20px;background:none;border:none;font-family:'Zen Kaku Gothic New',sans-serif;font-size:14px;font-weight:500;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s; }
.auth-tab.active { color:var(--text);border-bottom-color:var(--neon2); }
.auth-close { background:var(--bg3);border:none;color:var(--text2);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.2s; }
.auth-close:hover { background:var(--border2);color:var(--text); }
.auth-modal-body { padding:20px; }
.auth-field { margin-bottom:14px; }
.auth-label { display:block;font-size:12px;color:var(--text3);letter-spacing:0.06em;margin-bottom:6px;text-transform:uppercase; }
.auth-input { width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;font-size:14px;color:var(--text);font-family:'Zen Kaku Gothic New',sans-serif;outline:none;transition:border-color 0.2s; }
.auth-input:focus { border-color:var(--neon2); }
.auth-error { font-size:12px;color:var(--neon3);margin-bottom:10px;min-height:16px; }
.auth-submit-btn { width:100%;background:var(--text);color:var(--bg);border:none;padding:12px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s; }
.auth-submit-btn:hover { background:var(--neon);box-shadow:0 0 16px rgba(0,245,196,0.3); }
.auth-divider { text-align:center;margin:14px 0;position:relative;font-size:12px;color:var(--text3); }
.auth-divider::before,.auth-divider::after { content:'';position:absolute;top:50%;width:40%;height:1px;background:var(--border2); }
.auth-divider::before { left:0; } .auth-divider::after { right:0; }
.auth-guest-btn { width:100%;background:transparent;border:1px solid var(--border2);color:var(--text2);padding:10px;border-radius:8px;font-size:13px;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s; }
.auth-guest-btn:hover { border-color:var(--text2);color:var(--text); }

.profile-hero { padding:28px 16px 20px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;align-items:center; }
.profile-avatar-big { width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;margin-bottom:14px;border:3px solid var(--bg3);box-shadow:0 0 20px rgba(123,92,250,0.3); }
.profile-username { font-size:20px;font-weight:900;margin-bottom:6px; }
.profile-bio { font-size:13px;color:var(--text2);text-align:center;max-width:320px;line-height:1.6;margin-bottom:14px; }
.profile-stats { display:flex;gap:28px;margin-bottom:16px; }
.profile-stat { text-align:center; }
.profile-stat-num { font-family:'DotGothic16',monospace;font-size:22px;color:var(--neon);display:block;text-shadow:0 0 10px rgba(0,245,196,0.4); }
.profile-stat-label { font-size:11px;color:var(--text3); }
.profile-edit-btn { background:var(--bg3);border:1px solid var(--border2);color:var(--text2);padding:7px 20px;border-radius:20px;font-size:13px;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s; }
.profile-edit-btn:hover { border-color:var(--neon2);color:var(--neon2); }
.profile-edit-area { display:none;width:100%;max-width:340px;margin-top:14px; }
.profile-edit-area.open { display:block; }
.profile-edit-input { width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:9px 12px;font-size:13px;color:var(--text);font-family:'Zen Kaku Gothic New',sans-serif;outline:none;margin-bottom:8px;transition:border-color 0.2s; }
.profile-edit-input:focus { border-color:var(--neon2); }
.profile-save-btn { width:100%;background:var(--neon2);color:white;border:none;padding:9px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s; }
.profile-save-btn:hover { background:var(--neon);color:var(--bg); }
.guest-profile-wrap { padding:48px 20px;text-align:center; }
.guest-profile-icon { font-size:52px;margin-bottom:16px; }
.guest-profile-title { font-size:18px;font-weight:700;margin-bottom:8px; }
.guest-profile-desc { font-size:13px;color:var(--text2);line-height:1.7;margin-bottom:24px; }
.guest-signup-btn { display:block;width:100%;max-width:280px;margin:0 auto 12px;background:var(--text);color:var(--bg);border:none;padding:12px 32px;border-radius:24px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s; }
.guest-signup-btn:hover { background:var(--neon);box-shadow:0 0 16px rgba(0,245,196,0.3); }
.profile-tabs { display:flex;border-bottom:1px solid var(--border);position:sticky;top:52px;z-index:40;background:var(--bg); }
.profile-tab { flex:1;padding:13px 0;text-align:center;font-size:13px;font-weight:500;color:var(--text3);background:none;border:none;cursor:pointer;transition:color 0.2s;position:relative;font-family:'Zen Kaku Gothic New',sans-serif; }
.profile-tab.active { color:var(--text); }
.profile-tab.active::after { content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--neon3);border-radius:2px;box-shadow:0 0 8px var(--neon3); }
.nav-user-badge { display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border2);border-radius:20px;padding:4px 12px 4px 6px;cursor:pointer;transition:all 0.2s;font-size:13px; }
.nav-user-badge:hover { border-color:var(--neon2); }
.nav-user-avatar { width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê SUPABASE ‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://skrkdcvjwnqwogszdhka.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrcmtkY3Zqd25xd29nc3pkaGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjgzOTksImV4cCI6MjA4NzgwNDM5OX0.H1Y9f2aw4u_AqlVPKCWEsXYKeNqK5l-OJFwZV2_odUM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ‚ïê‚ïê‚ïê‚ïê ÂÆöÊï∞ ‚ïê‚ïê‚ïê‚ïê
const NG = ['Ê≠ª„Å≠','„Éñ„Çπ','„Ç≠„É¢„ÅÑ','„ÅÜ„Åñ„ÅÑ','Ê∂à„Åà„Çç','„Éá„Éñ','„Éê„Ç´','„Ç¢„Éõ','„ÇØ„ÇΩ','„Ç¥„Éü','Ê∞è„Å≠','ÊÆ∫„Åô','„ÇØ„Ç∫','„Åç„ÇÇ„ÅÑ','‰∏çÁ¥∞Â∑•','„Ç≠„É¢'];
const COLORS = ['linear-gradient(135deg,#00f5c4,#0077ff)','linear-gradient(135deg,#fa5c8a,#7b5cfa)','linear-gradient(135deg,#f5c842,#fa5c8a)','linear-gradient(135deg,#7b5cfa,#00f5c4)'];
const DRAMAS = {
  '‰∏çÈÅ©Âàá„Å´„ÇÇ„Åª„Å©„Åå„ÅÇ„ÇãÔºÅ': { emoji:'üì∫', genre:['„Ç≥„É°„Éá„Ç£','„Çø„Ç§„É†„Çπ„É™„ÉÉ„Éó','„Éí„É•„Éº„Éû„É≥'], channel:'TBS', day:'ÈáëÊõú', time:'22:00„Äú22:54', episodes:10, year:2024, streaming:[{name:'TBS„Éâ„É©„ÉûÂÖ¨Âºè',icon:'üì°'},{name:'Paravi',icon:'üé¨'},{name:'Amazon Prime',icon:'üì¶'},{name:'Netflix',icon:'üé•'}], desc:'Êò≠Âíå„ÅÆ„Åä„Åò„Åï„Çì„Åå‰ª§Âíå„Å´„Çø„Ç§„É†„Çπ„É™„ÉÉ„Éó„ÄÇ„Ç≥„É≥„Éó„É©„Ç§„Ç¢„É≥„Çπ„Å´Á∏õ„Çâ„Çå„ÅüÁèæ‰ª£Á§æ‰ºö„ÇíÈ¢®Âà∫„Åô„Çã„Ç≥„É°„Éá„Ç£„Éâ„É©„Éû„ÄÇ' },
  'ÂÖâ„ÇãÂêõ„Å∏': { emoji:'üìú', genre:['Â§ßÊ≤≥','Ê≠¥Âè≤','„É©„Éñ„Çπ„Éà„Éº„É™„Éº'], channel:'NHK', day:'Êó•Êõú', time:'20:00„Äú20:45', episodes:48, year:2024, streaming:[{name:'NHK„Ç™„É≥„Éá„Éû„É≥„Éâ',icon:'üì°'},{name:'U-NEXT',icon:'üé¨'}], desc:'Á¥´ÂºèÈÉ®Ôºà„Åæ„Å≤„ÇçÔºâ„ÅÆÁîüÊ∂Ø„Å®Âπ≥ÂÆâË≤¥Êóè„ÅÆ‰∏ñÁïå„ÇíÊèè„ÅèÂ§ßÊ≤≥„Éâ„É©„Éû„ÄÇ' },
  '„Åä„ÇÄ„Åô„Å≥': { emoji:'üçô', genre:['Êúù„Éâ„É©','„Éí„É•„Éº„Éû„É≥','ÊàêÈï∑'], channel:'NHK', day:'Êúà„ÄúÂúüÊõú', time:'08:00„Äú08:15', episodes:120, year:2024, streaming:[{name:'NHK„Ç™„É≥„Éá„Éû„É≥„Éâ',icon:'üì°'},{name:'TVer',icon:'üì±'}], desc:'Ê†ÑÈ§äÂ£´„ÇíÁõÆÊåá„ÅôÂ∞ëÂ•≥„ÅÆÊàêÈï∑„ÇíÊèè„ÅèÈÄ£Á∂ö„ÉÜ„É¨„ÉìÂ∞èË™¨„ÄÇ' },
};

// ‚ïê‚ïê‚ïê‚ïê Áä∂ÊÖã ‚ïê‚ïê‚ïê‚ïê
let posts = [];
let currentUser = null;
let currentProfile = null;
let myLikes = new Set();
let feedFilter = 'all';
let currentPage = 'feed';
let currentDrama = null;
let currentRating = 0;
let hasSpoiler = false;
let selectedEpisode = 'ÂÖ®‰Ωì';
let dramaEpFilter = 'all';
let replyTargetId = null;
let reportTarget = null;
let profileTabMode = 'posts';

// ‚ïê‚ïê‚ïê‚ïê „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ‚ïê‚ïê‚ïê‚ïê
function avatarColor(name) { let h=0; for(let c of name) h+=c.charCodeAt(0); return COLORS[h%COLORS.length]; }
function timeAgo(ts) {
  const d = (Date.now()-new Date(ts))/1000;
  if(d<60) return '„Åü„Å£„Åü‰ªä'; if(d<3600) return `${Math.floor(d/60)}ÂàÜÂâç`;
  if(d<86400) return `${Math.floor(d/3600)}ÊôÇÈñìÂâç`; return `${Math.floor(d/86400)}Êó•Ââç`;
}
function checkNG(text) { return NG.filter(w=>text.includes(w)); }

// ‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê
async function initAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) await setUser(session.user);
  sb.auth.onAuthStateChange(async (event, session) => {
    if (session) await setUser(session.user);
    else { currentUser = null; currentProfile = null; myLikes = new Set(); }
    updateNavUI();
    if (currentPage === 'profile') renderProfilePage();
  });
}

async function setUser(user) {
  currentUser = user;
  const { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
  currentProfile = data;
  const { data: likesData } = await sb.from('likes').select('post_id').eq('user_id', user.id);
  myLikes = new Set((likesData||[]).map(l => l.post_id));
}

function updateNavUI() {
  const right = document.getElementById('nav-right-area');
  if (!right) return;
  if (currentUser && currentProfile) {
    right.innerHTML = `
      <div class="nav-user-badge" onclick="switchPage('profile')">
        <div class="nav-user-avatar" style="background:${currentProfile.avatar_color}">${currentProfile.avatar_char}</div>
        <span>${currentProfile.username}</span>
      </div>`;
  } else {
    right.innerHTML = `
      <button class="btn-ghost" onclick="openAuthModal('login')" style="background:none;border:1px solid var(--border2);color:var(--text2);padding:6px 14px;border-radius:20px;font-size:13px;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s;">„É≠„Ç∞„Ç§„É≥</button>
      <button class="btn-primary" onclick="openAuthModal('signup')" style="background:var(--neon2);color:white;border:none;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Zen Kaku Gothic New',sans-serif;transition:all 0.2s;">ÁôªÈå≤</button>`;
  }
}

// ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ
function openAuthModal(tab='login') {
  switchAuthTab(tab);
  document.getElementById('auth-modal').classList.add('open');
}
function closeAuthModal() { document.getElementById('auth-modal').classList.remove('open'); }
function switchAuthTab(tab) {
  document.getElementById('auth-login-form').style.display = tab==='login'?'block':'none';
  document.getElementById('auth-signup-form').style.display = tab==='signup'?'block':'none';
  document.getElementById('tab-login').classList.toggle('active', tab==='login');
  document.getElementById('tab-signup').classList.toggle('active', tab==='signup');
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  if (!email||!pass) { errEl.textContent='„É°„Éº„É´„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; return; }
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { errEl.textContent = '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô'; return; }
  closeAuthModal();
  showToast('‚úÖ „É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ', 'neon');
  await loadPosts();
}

async function doSignup() {
  const name  = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass  = document.getElementById('signup-password').value;
  const errEl = document.getElementById('signup-error');
  errEl.textContent = '';
  if (!name||!email||!pass) { errEl.textContent='„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; return; }
  if (pass.length < 6) { errEl.textContent='„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; return; }
  const { error } = await sb.auth.signUp({ email, password: pass, options: { data: { username: name } } });
  if (error) { errEl.textContent = error.message; return; }
  closeAuthModal();
  showToast('üéâ ÁôªÈå≤ÂÆå‰∫ÜÔºÅ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'neon');
}

async function doLogout() {
  await sb.auth.signOut();
  currentUser = null; currentProfile = null; myLikes = new Set();
  updateNavUI();
  switchPage('feed');
  showToast('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü');
}

// ‚ïê‚ïê‚ïê‚ïê PROFILE PAGE ‚ïê‚ïê‚ïê‚ïê
async function renderProfilePage() {
  const el = document.getElementById('profile-content');
  const navRight = document.getElementById('profile-page-nav-right');

  if (!currentUser || !currentProfile) {
    if (navRight) navRight.innerHTML = '';
    el.innerHTML = `
      <div class="guest-profile-wrap">
        <div class="guest-profile-icon">üë§</div>
        <div class="guest-profile-title">„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰Ωú„Çç„ÅÜ</div>
        <div class="guest-profile-desc">ÁôªÈå≤„Åô„Çã„Å®ÊäïÁ®øÂ±•Ê≠¥„Éª„ÅÑ„ÅÑ„Å≠Â±•Ê≠¥„Åå<br>„Éó„É≠„Éï„Ç£„Éº„É´„Å´„Åæ„Å®„Åæ„Çä„Åæ„Åô„ÄÇ<br>„ÇÇ„Å°„Çç„Çì„Ç≤„Çπ„Éà„ÅÆ„Åæ„ÅæÈñ≤Ë¶ß„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ</div>
        <button class="guest-signup-btn" onclick="openAuthModal('signup')">ÁÑ°Êñô„ÅßÁôªÈå≤„Åô„Çã</button>
        <button class="guest-signup-btn" style="background:var(--bg3);color:var(--text2);border:1px solid var(--border2);" onclick="openAuthModal('login')">„É≠„Ç∞„Ç§„É≥</button>
      </div>`;
    return;
  }

  if (navRight) navRight.innerHTML = `<button class="nav-icon-btn" onclick="doLogout()" title="„É≠„Ç∞„Ç¢„Ç¶„Éà">üö™</button>`;

  // ÊäïÁ®ø„Éª„ÅÑ„ÅÑ„Å≠Êï∞ÂèñÂæó
  const myPosts = posts.filter(p => p.userId === currentUser.id);
  const likedPosts = posts.filter(p => myLikes.has(p.id));

  el.innerHTML = `
    <div class="profile-hero">
      <div class="profile-avatar-big" style="background:${currentProfile.avatar_color}">${currentProfile.avatar_char}</div>
      <div class="profile-username">${currentProfile.username}</div>
      <div class="profile-bio">${currentProfile.bio || '„Åæ„Å†Ëá™Â∑±Á¥π‰ªã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}</div>
      <div class="profile-stats">
        <div class="profile-stat"><span class="profile-stat-num">${myPosts.length}</span><span class="profile-stat-label">ÊäïÁ®ø</span></div>
        <div class="profile-stat"><span class="profile-stat-num">${likedPosts.length}</span><span class="profile-stat-label">„ÅÑ„ÅÑ„Å≠</span></div>
      </div>
      <button class="profile-edit-btn" onclick="toggleProfileEdit()">„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ</button>
      <div class="profile-edit-area" id="profile-edit-area">
        <input class="profile-edit-input" id="edit-username" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" value="${currentProfile.username}" />
        <textarea class="profile-edit-input" id="edit-bio" placeholder="Ëá™Â∑±Á¥π‰ªãÔºà‰ªªÊÑèÔºâ" rows="3" style="resize:vertical">${currentProfile.bio||''}</textarea>
        <button class="profile-save-btn" onclick="saveProfile()">‰øùÂ≠ò„Åô„Çã</button>
      </div>
    </div>
    <div class="profile-tabs">
      <button class="profile-tab active" id="ptab-posts" onclick="setProfileTab('posts',this)">ÊäïÁ®ø</button>
      <button class="profile-tab" id="ptab-likes" onclick="setProfileTab('likes',this)">„ÅÑ„ÅÑ„Å≠</button>
    </div>
    <div id="profile-tab-content">
      ${renderProfilePostList(myPosts)}
    </div>`;
}

function renderProfilePostList(list) {
  if (list.length === 0) return '<div style="padding:40px 16px;text-align:center;color:var(--text3)">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
  return list.map((p,i) => renderPost(p,i)).join('');
}

function setProfileTab(tab, btn) {
  profileTabMode = tab;
  document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const myPosts = posts.filter(p => p.userId === currentUser?.id);
  const likedPosts = posts.filter(p => myLikes.has(p.id));
  const list = tab === 'posts' ? myPosts : likedPosts;
  document.getElementById('profile-tab-content').innerHTML = renderProfilePostList(list);
}

function toggleProfileEdit() {
  document.getElementById('profile-edit-area').classList.toggle('open');
}

async function saveProfile() {
  const username = document.getElementById('edit-username').value.trim();
  const bio = document.getElementById('edit-bio').value.trim();
  if (!username) { showToast('„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn'); return; }
  const { error } = await sb.from('profiles').update({
    username, bio,
    avatar_char: username[0]
  }).eq('id', currentUser.id);
  if (error) { showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warn'); return; }
  currentProfile.username = username;
  currentProfile.bio = bio;
  currentProfile.avatar_char = username[0];
  showToast('‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'neon');
  updateNavUI();
  renderProfilePage();
}

// ‚ïê‚ïê‚ïê‚ïê LOAD POSTS ‚ïê‚ïê‚ïê‚ïê
async function loadPosts() {
  showLoadingIndicator(true);
  const { data, error } = await sb.from('posts').select('*, replies(*)').order('created_at', { ascending: false });
  if (error) { showToast('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº', 'warn'); showLoadingIndicator(false); return; }
  posts = (data||[]).map(p => ({
    id: p.id,
    userId: p.user_id,
    user: p.user_name,
    avatar: p.avatar,
    avatarColor: p.avatar_color,
    drama: p.drama,
    episode: p.episode,
    rating: p.rating,
    body: p.body,
    spoiler: p.spoiler,
    likes: p.likes,
    liked: myLikes.has(p.id),
    frozen: p.frozen,
    time: timeAgo(p.created_at),
    replies: (p.replies||[]).map(r => ({
      id:r.id, user:r.user_name, avatar:r.avatar, avatarColor:r.avatar_color,
      body:r.body, likes:r.likes, liked:false, time:timeAgo(r.created_at),
    })).sort((a,b)=>a.id-b.id),
  }));
  showLoadingIndicator(false);
  renderFeed();
  if (currentDrama) renderDramaPage(currentDrama);
  if (currentPage === 'profile') renderProfilePage();
}

function showLoadingIndicator(on) {
  let el = document.getElementById('feed-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'feed-loading';
    el.style.cssText = 'padding:40px;text-align:center;color:var(--text3);font-size:14px;';
    el.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶';
    document.getElementById('feed').prepend(el);
  }
  el.style.display = on ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê SUBMIT POST ‚ïê‚ïê‚ïê‚ïê
async function submitPost() {
  const drama = document.getElementById('c-drama').value.trim();
  const body  = document.getElementById('c-body').value.trim();
  let userName, avatarChar, avatarCol;

  if (currentUser && currentProfile) {
    userName = currentProfile.username;
    avatarChar = currentProfile.avatar_char;
    avatarCol = currentProfile.avatar_color;
  } else {
    const guestName = document.getElementById('c-user').value.trim();
    if (!guestName) { showToast('„Ç≤„Çπ„Éà„ÅÆÂ†¥Âêà„ÅØ„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn'); return; }
    userName = guestName; avatarChar = guestName[0]; avatarCol = avatarColor(guestName);
  }
  if (!drama || !body) { showToast('„Éâ„É©„Éû„Çø„Ç§„Éà„É´„Å®ÊÑüÊÉ≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn'); return; }

  if (checkNG(body).length) { await handleViolation(userName); return; }

  const { error } = await sb.from('posts').insert({
    user_id: currentUser?.id || null,
    user_name: userName, avatar: avatarChar, avatar_color: avatarCol,
    drama, episode: selectedEpisode||'ÂÖ®‰Ωì',
    rating: currentRating||3, body, spoiler: hasSpoiler,
  });
  if (error) { showToast('ÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warn'); return; }

  // reset form
  document.getElementById('c-drama').value = '';
  document.getElementById('c-body').value = '';
  if (!currentUser) document.getElementById('c-user').value = '';
  selectedEpisode='ÂÖ®‰Ωì'; currentRating=0; hasSpoiler=false;
  updateStars();
  document.getElementById('c-spoiler').classList.remove('on');
  document.getElementById('mod-warn').classList.remove('show');
  document.querySelectorAll('.ep-dropdown-item').forEach(c=>c.classList.remove('selected'));
  const allItem = document.querySelector('.ep-dropdown-item.all');
  if (allItem) allItem.classList.add('selected');
  const val = document.getElementById('ep-selected-val');
  if (val) { val.textContent='üé¨ Ë©±Êï∞„ÇíÈÅ∏„Å∂'; val.classList.add('default'); }

  showToast('‚ú® ÊäïÁ®ø„Åó„Åæ„Åó„ÅüÔºÅ', 'neon');
  await loadPosts();
}

// ‚ïê‚ïê‚ïê‚ïê LIKE ‚ïê‚ïê‚ïê‚ïê
async function toggleLike(id) {
  const p = posts.find(p=>p.id===id);
  if (!p||p.frozen) return;

  if (currentUser) {
    // „É≠„Ç∞„Ç§„É≥Ê∏à„ÅøÔºöDB„Å´‰øùÂ≠ò
    if (myLikes.has(id)) {
      await sb.from('likes').delete().eq('user_id', currentUser.id).eq('post_id', id);
      myLikes.delete(id);
      await sb.from('posts').update({ likes: p.likes-1 }).eq('id', id);
      p.likes--; p.liked = false;
    } else {
      await sb.from('likes').insert({ user_id: currentUser.id, post_id: id });
      myLikes.add(id);
      await sb.from('posts').update({ likes: p.likes+1 }).eq('id', id);
      p.likes++; p.liked = true;
    }
  } else {
    // „Ç≤„Çπ„ÉàÔºö„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ„Åø
    p.liked = !p.liked;
    const newLikes = p.liked ? p.likes+1 : p.likes-1;
    await sb.from('posts').update({ likes: newLikes }).eq('id', id);
    p.likes = newLikes;
  }
  renderFeed();
  if (currentDrama) renderDramaPage(currentDrama);
}

// ‚ïê‚ïê‚ïê‚ïê REPLY ‚ïê‚ïê‚ïê‚ïê
async function submitReply() {
  const text = document.getElementById('reply-modal-text').value.trim();
  let name, avatarChar, avatarCol;
  if (currentUser && currentProfile) {
    name = currentProfile.username; avatarChar = currentProfile.avatar_char; avatarCol = currentProfile.avatar_color;
  } else {
    name = document.getElementById('reply-modal-name').value.trim();
    if (!name) { showToast('„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn'); return; }
    avatarChar = name[0]; avatarCol = avatarColor(name);
  }
  if (!text) { showToast('Ëøî‰ø°ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warn'); return; }
  if (checkNG(text).length) { await handleViolation(name, true); return; }

  const { error } = await sb.from('replies').insert({
    post_id: replyTargetId, user_id: currentUser?.id||null,
    user_name: name, avatar: avatarChar, avatar_color: avatarCol, body: text,
  });
  if (error) { showToast('Ëøî‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'warn'); return; }
  document.getElementById('reply-modal-text').value = '';
  document.getElementById('reply-modal-warn').textContent = '';
  showToast('üí¨ Ëøî‰ø°„Åó„Åæ„Åó„ÅüÔºÅ', 'neon');
  await loadPosts();
  const p = posts.find(x=>x.id===replyTargetId);
  if (p) renderModalReplies(p);
}

async function toggleReplyLike(postId, replyId) {
  const p = posts.find(x=>x.id===postId);
  if (!p) return;
  const r = (p.replies||[]).find(x=>x.id===replyId);
  if (!r) return;
  r.liked = !r.liked;
  const newLikes = r.liked ? r.likes+1 : r.likes-1;
  await sb.from('replies').update({ likes: newLikes }).eq('id', replyId);
  r.likes = newLikes;
  renderFeed();
  if (currentDrama) renderDramaPage(currentDrama);
  if (replyTargetId===postId) renderModalReplies(p);
}

// ‚ïê‚ïê‚ïê‚ïê VIOLATION / REPORT ‚ïê‚ïê‚ïê‚ïê
async function handleViolation(userName) {
  const { data: existing } = await sb.from('violations').select('*').eq('user_name', userName).single();
  if (existing) {
    const newCount = existing.count+1;
    const shouldFreeze = newCount >= 2;
    await sb.from('violations').update({ count: newCount, frozen: shouldFreeze }).eq('user_name', userName);
    if (shouldFreeze) {
      await sb.from('posts').update({ frozen: true }).eq('user_name', userName);
      showToast(`üîí ${userName} „ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂáçÁµê„Åó„Åæ„Åó„Åü`, 'warn');
    } else {
      showToast(`‚ö†Ô∏è Ë≠¶Âëä ${newCount}/2 ‚Äî „ÅÇ„Å®${2-newCount}Âõû„ÅßÂáçÁµê`, 'warn');
    }
  } else {
    await sb.from('violations').insert({ user_name: userName, count:1, frozen:false });
    showToast('‚ö†Ô∏è Ë≠¶Âëä 1/2 ‚Äî „ÅÇ„Å®1Âõû„ÅßÂáçÁµê', 'warn');
  }
  await loadPosts();
}

function openReport(id) { reportTarget=id; document.getElementById('sheet-backdrop').classList.add('open'); }
function closeSheet() { document.getElementById('sheet-backdrop').classList.remove('open'); }
async function confirmReport() {
  const p = posts.find(p=>p.id===reportTarget);
  if (p) await handleViolation(p.user);
  closeSheet();
}

// ‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê
function renderFeed() {
  const el = document.getElementById('feed');
  let list = posts;
  if (feedFilter==='nospoiler') list = posts.filter(p=>!p.spoiler);
  if (feedFilter==='spoiler') list = posts.filter(p=>p.spoiler);
  if (list.length===0) { el.innerHTML='<div style="padding:60px 16px;text-align:center;color:var(--text3)">„Åæ„Å†ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br>ÊúÄÂàù„ÅÆÊÑüÊÉ≥„ÇíÊäïÁ®ø„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</div>'; return; }
  el.innerHTML = list.map((p,i)=>renderPost(p,i)).join('');
}

function renderPost(p, i=0) {
  const stars=[1,2,3,4,5].map(s=>`<span class="p-star ${s<=p.rating?'on':''}">‚òÖ</span>`).join('');
  const isMyPost = currentUser && p.userId === currentUser.id;
  const bodyHtml = p.frozen
    ? '<span style="color:var(--text3)">[Ë¶èÁ¥ÑÈÅïÂèç„Å´„Çà„ÇäÈùûË°®Á§∫]</span>'
    : p.spoiler
      ? `<div class="p-text"><span class="spoiler-blur" onclick="this.classList.toggle('revealed')">${p.body}</span></div>`
      : `<div class="p-text">${p.body}</div>`;
  const replyCount = (p.replies||[]).length;
  const likedNow = currentUser ? myLikes.has(p.id) : p.liked;
  return `
  <div class="post-card ${p.frozen?'frozen':''}" style="animation-delay:${i*0.04}s">
    <div class="post-inner">
      <div class="post-avatar-col">
        <div class="p-avatar" style="background:${p.avatarColor}">${p.avatar}</div>
        <div class="thread-line"></div>
      </div>
      <div class="post-body-col">
        <div class="post-head">
          <span class="p-username">${p.user}${isMyPost?' <span style="font-size:10px;color:var(--neon2);background:rgba(123,92,250,0.15);padding:1px 6px;border-radius:10px;font-weight:500">Ëá™ÂàÜ</span>':''}${p.frozen?' üîí':''}</span>
          <span class="p-time">${p.time}</span>
        </div>
        <div class="p-drama-tag" onclick="openDrama('${p.drama}')">üì∫ ${p.drama} <span class="arrow">‚Üó</span></div>
        ${p.episode?`<div class="ep-badge ${p.episode==='ÂÖ®‰Ωì'?'all':''}">üé¨ ${p.episode}</div>`:''}
        <div class="p-stars">${stars}</div>
        ${p.spoiler?'<div class="spoiler-badge">‚ö†Ô∏è „Éç„Çø„Éê„É¨„ÅÇ„Çä ‚Äî „Çø„ÉÉ„Éó„ÅßË°®Á§∫</div>':''}
        ${bodyHtml}
        <div class="post-actions">
          <button class="p-action ${likedNow?'liked':''}" onclick="toggleLike(${p.id})">
            <span class="icon">${likedNow?'‚ô•':'‚ô°'}</span> ${p.likes}
          </button>
          <button class="p-action" onclick="openReplyModal(${p.id})">
            <span class="icon">üí¨</span> ${replyCount>0?replyCount:'Ëøî‰ø°'}
          </button>
          <button class="p-action" onclick="openReport(${p.id})"><span class="icon">üö©</span></button>
        </div>
      </div>
    </div>
    ${replyCount>0?renderInlineReplies(p):''}
  </div>`;
}

function renderInlineReplies(p) {
  const replies=p.replies||[];
  if(replies.length===0) return '';
  const preview=replies[replies.length-1];
  const moreCount=replies.length-1;
  return `<div style="padding:0 16px 12px 68px;">
    <div class="reply-item">
      <div class="r-avatar" style="background:${preview.avatarColor||'linear-gradient(135deg,var(--neon2),var(--neon3))'}">${preview.avatar}</div>
      <div class="r-body">
        <div class="r-head"><span class="r-name">${preview.user}</span><span class="r-time">${preview.time}</span></div>
        <div class="r-text">${preview.body}</div>
        <div class="r-actions">
          <button class="r-action ${preview.liked?'liked':''}" onclick="toggleReplyLike(${p.id},${preview.id})">${preview.liked?'‚ô•':'‚ô°'} ${preview.likes}</button>
          <button class="r-action" onclick="openReplyModal(${p.id})">Ëøî‰ø°</button>
        </div>
      </div>
    </div>
    ${moreCount>0?`<button class="show-replies-btn" onclick="openReplyModal(${p.id})">‚Äî ‰ªñ${moreCount}‰ª∂„ÅÆËøî‰ø°„ÇíË¶ã„Çã</button>`:''}
  </div>`;
}

function openReplyModal(postId) {
  replyTargetId=postId;
  const p=posts.find(x=>x.id===postId);
  if(!p) return;
  // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÖ•ÂäõÊ¨Ñ„ÇíÈùûË°®Á§∫
  const nameField = document.getElementById('reply-modal-name');
  if (nameField) {
    nameField.style.display = currentUser ? 'none' : 'block';
    if (currentUser && currentProfile) nameField.value = currentProfile.username;
  }
  document.getElementById('reply-modal-orig').innerHTML=`
    <div style="display:flex;gap:10px;align-items:flex-start">
      <div class="r-avatar" style="background:${p.avatarColor};width:32px;height:32px;font-size:12px;">${p.avatar}</div>
      <div>
        <div class="p-username" style="font-size:13px;margin-bottom:3px">${p.user} <span style="color:var(--text3);font-weight:400">${p.time}</span></div>
        <div class="p-text" style="font-size:13px;color:var(--text2);margin-bottom:0">${p.frozen?'[Ë¶èÁ¥ÑÈÅïÂèç„Å´„Çà„ÇäÈùûË°®Á§∫]':p.body.slice(0,120)+(p.body.length>120?'‚Ä¶':'')}</div>
      </div>
    </div>`;
  renderModalReplies(p);
  document.getElementById('reply-modal-text').value='';
  document.getElementById('reply-modal-warn').textContent='';
  document.getElementById('reply-modal-backdrop').classList.add('open');
  setTimeout(()=>document.getElementById('reply-modal-text').focus(),300);
}

function renderModalReplies(p) {
  const replies=p.replies||[];
  document.getElementById('modal-replies-list').innerHTML=replies.length===0
    ?'<div style="padding:20px 0;text-align:center;color:var(--text3);font-size:13px">„Åæ„Å†Ëøî‰ø°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
    :replies.map(r=>`
      <div class="modal-reply-item">
        <div class="r-avatar" style="background:${r.avatarColor||'linear-gradient(135deg,var(--neon2),var(--neon3))'};width:32px;height:32px;font-size:12px">${r.avatar}</div>
        <div class="r-body">
          <div class="r-head"><span class="r-name">${r.user}</span><span class="r-time">${r.time}</span></div>
          <div class="r-text">${r.body}</div>
          <div class="r-actions">
            <button class="r-action ${r.liked?'liked':''}" onclick="toggleReplyLike(${p.id},${r.id})">${r.liked?'‚ô•':'‚ô°'} ${r.likes}</button>
            <button class="r-action" onclick="openReport(${p.id})">üö©</button>
          </div>
        </div>
      </div>`).join('');
}

function closeReplyModal() { document.getElementById('reply-modal-backdrop').classList.remove('open'); replyTargetId=null; }
function onReplyInput() {
  const found=checkNG(document.getElementById('reply-modal-text').value);
  document.getElementById('reply-modal-warn').textContent=found.length?`‚ö†Ô∏è„Äå${found[0]}„Äç„Å™„Å©‰∏çÈÅ©Âàá„Å™Ë°®Áèæ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô`:'';
}

// ‚ïê‚ïê‚ïê‚ïê DRAMA PAGE ‚ïê‚ïê‚ïê‚ïê
function openDrama(name) { currentDrama=name; dramaEpFilter='all'; document.getElementById('drama-page-title').textContent=name; renderDramaPage(name); showPage('drama'); }

function renderDramaPage(name) {
  const d=DRAMAS[name];
  const dramaPosts=posts.filter(p=>p.drama===name);
  const avgRating=dramaPosts.length?(dramaPosts.reduce((a,p)=>a+p.rating,0)/dramaPosts.length).toFixed(1):'-';
  const dist=[5,4,3,2,1].map(s=>({star:s,count:dramaPosts.filter(p=>p.rating===s).length}));
  const maxDist=Math.max(...dist.map(d=>d.count),1);
  const streamingHtml=d?d.streaming.map(s=>`<div class="stream-badge"><span class="stream-icon">${s.icon}</span>${s.name}</div>`).join(''):'';
  const infoHtml=d?`
    <div class="drama-hero">
      <div class="drama-title-row">
        <div class="drama-thumb">${d.emoji}</div>
        <div class="drama-info">
          <div class="drama-main-title">${name}</div>
          <div style="font-size:13px;color:var(--text2);margin-top:4px">${d.desc}</div>
          <div class="drama-genre-tags">${d.genre.map(g=>`<span class="genre-chip">${g}</span>`).join('')}</div>
        </div>
      </div>
      <div class="drama-rating-big">
        <div class="rating-num">${avgRating}</div>
        <div class="rating-right">
          <div class="rating-stars-big">${[1,2,3,4,5].map(s=>`<span class="r-star ${parseFloat(avgRating)>=s?'on':''}">‚òÖ</span>`).join('')}</div>
          <div class="rating-count">${dramaPosts.length}‰ª∂„ÅÆ„É¨„Éì„É•„Éº</div>
        </div>
      </div>
      <div class="drama-info-grid">
        <div class="info-card"><div class="info-card-label">ÊîæÈÄÅÂ±Ä</div><div class="info-card-val">${d.channel}</div></div>
        <div class="info-card"><div class="info-card-label">ÊîæÈÄÅÊôÇÈñì</div><div class="info-card-val">${d.day}</div><div class="info-card-sub">${d.time}</div></div>
        <div class="info-card"><div class="info-card-label">ÂÖ®Ë©±Êï∞</div><div class="info-card-val">${d.episodes}Ë©±</div></div>
        <div class="info-card"><div class="info-card-label">ÊîæÈÄÅÂπ¥</div><div class="info-card-val">${d.year}</div></div>
      </div>
      <div style="font-size:12px;color:var(--text3);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px">Ë¶ñËÅ¥ÊñπÊ≥ï</div>
      <div class="streaming-row">${streamingHtml}</div>
    </div>
    <div class="drama-tabs">
      <button class="drama-tab active" onclick="setDramaTab('reviews',this)">Âè£„Ç≥„Éü</button>
      <button class="drama-tab" onclick="setDramaTab('stats',this)">Áµ±Ë®à</button>
    </div>`
  :`<div style="padding:24px 16px;color:var(--text2)">„Åì„ÅÆ„Éâ„É©„Éû„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
    <div class="drama-tabs"><button class="drama-tab active" onclick="setDramaTab('reviews',this)">Âè£„Ç≥„Éü</button></div>`;
  const statsHtml=`<div id="drama-tab-stats" style="display:none"><div class="stat-bar-wrap"><div style="font-size:13px;color:var(--text2);margin-bottom:12px">Ë©ï‰æ°„ÅÆÂàÜÂ∏É</div>${dist.map(d=>`<div class="stat-bar-row"><div class="stat-bar-label">‚òÖ${d.star}</div><div class="stat-bar-track"><div class="stat-bar-fill" style="width:${Math.round(d.count/maxDist*100)}%"></div></div><div class="stat-bar-cnt">${d.count}</div></div>`).join('')}</div></div>`;
  const reviewsHtml=`<div id="drama-tab-reviews">${buildEpFilterBar(name)}${dramaPosts.length===0?`<div style="padding:40px 16px;text-align:center;color:var(--text3)">„Åæ„Å†Âè£„Ç≥„Éü„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`:dramaPosts.map((p,i)=>renderPost(p,i)).join('')}</div>`;
  document.getElementById('drama-detail-content').innerHTML=infoHtml+reviewsHtml+statsHtml;
}

function setDramaTab(tab,btn) {
  document.querySelectorAll('.drama-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active');
  document.getElementById('drama-tab-reviews').style.display=tab==='reviews'?'block':'none';
  const s=document.getElementById('drama-tab-stats'); if(s) s.style.display=tab==='stats'?'block':'none';
}

function buildEpFilterBar(name) {
  const dp=posts.filter(p=>p.drama===name);
  const eps=[...new Set(dp.map(p=>p.episode||'ÂÖ®‰Ωì'))].sort((a,b)=>a==='ÂÖ®‰Ωì'?-1:b==='ÂÖ®‰Ωì'?1:parseInt(a)-parseInt(b));
  if(eps.length<=1) return '';
  return `<div class="ep-filter-bar" id="ep-filter-bar"><div class="ep-filter-inner"><div class="ep-filter-chip all active" onclick="setEpFilter('all',this)">„Åô„Åπ„Å¶</div>${eps.map(ep=>`<div class="ep-filter-chip ${ep==='ÂÖ®‰Ωì'?'all':''}" onclick="setEpFilter('${ep}',this)">${ep}</div>`).join('')}</div></div>`;
}

function setEpFilter(ep,el) {
  dramaEpFilter=ep;
  document.querySelectorAll('.ep-filter-chip').forEach(c=>c.classList.remove('active')); el.classList.add('active');
  const allPosts=posts.filter(p=>p.drama===currentDrama);
  const filtered=ep==='all'?allPosts:allPosts.filter(p=>(p.episode||'ÂÖ®‰Ωì')===ep);
  const reviewsEl=document.getElementById('drama-tab-reviews');
  if(reviewsEl){ const bar=reviewsEl.querySelector('.ep-filter-bar')?.outerHTML||''; reviewsEl.innerHTML=bar+(filtered.length===0?`<div style="padding:40px 16px;text-align:center;color:var(--text3)">„Äå${ep}„Äç„ÅÆÂè£„Ç≥„Éü„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>`:filtered.map((p,i)=>renderPost(p,i)).join('')); }
}

// ‚ïê‚ïê‚ïê‚ïê EPISODE DROPDOWN ‚ïê‚ïê‚ïê‚ïê
function toggleEpDropdown() { document.getElementById('ep-dropdown-btn').classList.toggle('open'); document.getElementById('ep-dropdown-menu').classList.toggle('open'); }
function selectEpisode(ep,el) {
  selectedEpisode=ep;
  document.querySelectorAll('.ep-dropdown-item').forEach(c=>c.classList.remove('selected')); el.classList.add('selected');
  const val=document.getElementById('ep-selected-val');
  val.textContent=ep==='ÂÖ®‰Ωì'?'üì∫ ÂÖ®‰ΩìÔºà„Ç∑„É™„Éº„Ç∫ÂÖ®‰ΩìÔºâ':`üé¨ ${ep}`; val.classList.remove('default');
  document.getElementById('ep-dropdown-btn').classList.remove('open'); document.getElementById('ep-dropdown-menu').classList.remove('open');
}
document.addEventListener('click',e=>{ const w=document.getElementById('ep-field-wrap'); if(w&&!w.contains(e.target)){ document.getElementById('ep-dropdown-btn')?.classList.remove('open'); document.getElementById('ep-dropdown-menu')?.classList.remove('open'); } });

// ‚ïê‚ïê‚ïê‚ïê STARS ‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.c-star').forEach(btn=>{
  btn.addEventListener('click',()=>{ currentRating=parseInt(btn.dataset.v); updateStars(); });
  btn.addEventListener('mouseenter',()=>{ const v=parseInt(btn.dataset.v); document.querySelectorAll('.c-star').forEach(b=>b.classList.toggle('on',parseInt(b.dataset.v)<=v)); });
  btn.addEventListener('mouseleave',updateStars);
});
function updateStars() { document.querySelectorAll('.c-star').forEach(b=>b.classList.toggle('on',parseInt(b.dataset.v)<=currentRating)); }

// ‚ïê‚ïê‚ïê‚ïê SPOILER ‚ïê‚ïê‚ïê‚ïê
function toggleSpoiler() { hasSpoiler=!hasSpoiler; document.getElementById('c-spoiler').classList.toggle('on',hasSpoiler); }

// ‚ïê‚ïê‚ïê‚ïê MOD WARNING ‚ïê‚ïê‚ïê‚ïê
function onBodyInput() {
  const found=checkNG(document.getElementById('c-body').value);
  const warn=document.getElementById('mod-warn'); const msg=document.getElementById('mod-msg');
  if(found.length){ msg.textContent=`„Äå${found[0]}„Äç„Å™„Å©‰∏çÈÅ©Âàá„Å™Ë°®Áèæ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`; warn.classList.add('show'); } else warn.classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê FILTER / SEARCH / NAV ‚ïê‚ïê‚ïê‚ïê
function setFeedTab(mode,btn) { feedFilter=mode; document.querySelectorAll('.feed-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); renderFeed(); }

function onSearch(q) {
  const res=document.getElementById('search-results');
  if(!q){ renderTrending(); return; }
  const names=[...new Set(posts.map(p=>p.drama))].filter(n=>n.includes(q));
  res.innerHTML=`<div class="trending-section">${names.length===0?'<div style="color:var(--text3);text-align:center;padding:40px 0">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>':names.map(n=>`<div class="trending-drama-item" onclick="openDrama('${n}')"><div class="td-info"><div class="td-name">${n}</div><div class="td-meta">${posts.filter(p=>p.drama===n).length}‰ª∂„ÅÆÂè£„Ç≥„Éü</div></div></div>`).join('')}</div>`;
}

function renderTrending() {
  const counts={}; posts.forEach(p=>{counts[p.drama]=(counts[p.drama]||0)+1;});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  document.getElementById('search-results').innerHTML=`<div class="trending-section"><div class="trending-label">üî• „Éà„É¨„É≥„Éâ</div>${sorted.map(([name,cnt],i)=>`<div class="trending-drama-item" onclick="openDrama('${name}')"><div class="td-rank ${i<3?'top':''}">${i+1}</div><div class="td-info"><div class="td-name">${name}</div><div class="td-meta">${cnt}‰ª∂„ÅÆÂè£„Ç≥„Éü</div></div><div class="td-count">${cnt}‰ª∂</div></div>`).join('')}</div>`;
}

function switchPage(name) {
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  const bnavId = {feed:'home',search:'search',profile:'profile'}[name];
  if (bnavId) document.getElementById('bnav-'+bnavId)?.classList.add('active');
  showPage(name);
  if(name==='search') renderTrending();
  if(name==='profile') renderProfilePage();
}
function showPage(name) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('page-'+name).classList.add('active'); currentPage=name; window.scrollTo(0,0); }
function goBack() { showPage('feed'); currentDrama=null; }
function goHome() { switchPage('feed'); }

function showToast(msg,type='') { const el=document.getElementById('toast'); el.textContent=msg; el.className='toast show '+type; setTimeout(()=>el.classList.remove('show'),2800); }

// ‚ïê‚ïê‚ïê‚ïê REALTIME ‚ïê‚ïê‚ïê‚ïê
function subscribeRealtime() {
  sb.channel('public:posts').on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>loadPosts()).on('postgres_changes',{event:'*',schema:'public',table:'replies'},()=>loadPosts()).subscribe();
}

// ‚ïê‚ïê‚ïê‚ïê NAV RIGHT „Ç®„É™„Ç¢„ÇíÂãïÁöÑID„Å´ ‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const navRight = document.querySelector('.topnav .nav-right');
  if (navRight) navRight.id = 'nav-right-area';
});

// ‚ïê‚ïê‚ïê‚ïê „Ç≤„Çπ„ÉàÁî®„Éã„ÉÉ„ÇØ„Éç„Éº„É†Ê¨Ñ„ÅÆË°®Á§∫Âà∂Âæ° ‚ïê‚ïê‚ïê‚ïê
function updateComposerForAuth() {
  const userField = document.getElementById('c-user');
  if (!userField) return;
  if (currentUser && currentProfile) {
    userField.style.display = 'none';
  } else {
    userField.style.display = 'block';
  }
}

// ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
(async () => {
  await initAuth();
  updateNavUI();
  updateComposerForAuth();
  await loadPosts();
  subscribeRealtime();
})();
</script>
</body>
</html>
